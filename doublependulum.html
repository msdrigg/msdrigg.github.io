<!DOCTYPE html>
<meta charset="utf-8">
<head>
	<style>
		html {
		  -webkit-user-select: none; /* Safari */        
		  -moz-user-select: none; /* Firefox */
		  -ms-user-select: none; /* IE10+/Edge */
		  user-select: none; /* Standard */
		  background-color: black;
		  color: white;
		}
		.title {
		  text-align: center;
		}
		h4 {
		  text-color: #FFF;
		  font: bold 19px sans-serif;
		  text-anchor: middle;
		}
		p {
		  fill: #FFF;
		  font: 12px sans-serif;
		  text-anchor: middle;
		  padding: 0px;
		}
		.footer p {
		  fill: #FFF
		  font: 12px sans-serif;
		  padding-left: 36px;
		  text-indent: -36px;
		}
		h5 {
		  fill: #FFF
		  margin-block-end: .8em;
		  font: bold 14px sans-serif;	
		  margin-block-start: 3em;
		}
		.pendulumLine1, .pendulumLine2 {
		  "stroke-width", 5;
		}
	</style>
	<link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<script src="./doublePendulumLA.js"></script>
	<script src="https://d3js.org/d3-selection.v1.min.js"></script>
	<script src="https://d3js.org/d3-array.v2.min.js"></script>
	<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
	<script src="https://d3js.org/d3-color.v1.min.js"></script>
	<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
	<script src="https://d3js.org/d3-format.v1.min.js"></script>
	<script src="https://d3js.org/d3-scale.v3.min.js"></script>
	<script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
	<script src="https://d3js.org/d3-ease.v1.min.js"></script>
	<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
	<script src="https://d3js.org/d3-selection.v1.min.js"></script>
</head>

<body>
<div id="mainID" class="title">
<h4>
  The chaos of double pendulums
</h4>
</div>
<div class="footer">
  <h5>
  Sources
  </h5>
  <p>
  Assencio, Diego. &quotThe double pendulum: Hamiltonian formulation.&quot 17 May 2014. https://diego.assencio.com/?index=e5ac36fcb129ce95a61f8e8ce0572dbf. Accessed 31 Mar. 2020.
  </p>
</div>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js"> </script>
<script>

const lengthScale = 18, 
	stepSize = 0.0005,
	repeats = 32;


let timerID = 0,
	started = false;
let currentCoords,
	currentTime;

let origin, dots1, lines1, dots2, lines2;

const constants = [8, 5, 6, 5],
	pendulumNumber = 100,
	deviation = 0.0005,
	initialTime = 0;
let continueLooping = false,
	currentCartCoords,
	restartable = false,
	colorscaleVariable = 0;
let goodColorScales = [d3.interpolateOranges, d3.interpolateInferno, d3.interpolatePlasma],
	colorScale = goodColorScales[1];

const width = 2*lengthScale*(constants[0] + constants[2])*1.05,
    height = 2*lengthScale*(constants[0] + constants[2])*1.05;

let svg = d3.select(".title").append("svg")
    .attr("width", width)
    .attr("height", height);

currentTime = initialTime;
	const initialCoords = initPendulums(1.5, 3.1, deviation, pendulumNumber);
	const initialCoordsCart = convertToCoordinates(initialCoords, constants);



function startLoop() {
	<!-- timerID = setInterval(updateDisplay, 1); -->
	if (! continueLooping ) {
		continueLooping = true;
		requestAnimationFrame(updateDisplay);
	}
}

function stopLoop() {
	<!-- clearInterval(timerID) -->
	if (continueLooping) continueLooping = false;
}

function inputInitialData(){
	let origin = svg.append('g')
		.attr("transform", "translate(" + (width/2) + "," + (height/4) + ")")
		.attr("class", "origin");

	let pendulums = origin.selectAll('.pendulums')
		.data(initialCoordsCart).enter()
		.append('g').attr("class", "pendulums");

	lines1 = pendulums
		.append('line')
		.attr("class", "pendulumLine1")
		.attr("x1", 0)
		.attr("y1", 0)
		.attr("x2", function (d) { return d[0]*lengthScale;})
		.attr("y2", function (d) { return d[1]*lengthScale;})
		.attr("stroke", function(d, i) { return colorScale(i/(pendulumNumber + 5));});
		
	lines2 = pendulums
		.append('line')
		.attr("class", "pendulumLine2")
		.attr("x1", function (d) { return d[0]*lengthScale;})
		.attr("y1", function (d) { return d[1]*lengthScale;})
		.attr("x2", function (d) { return d[2]*lengthScale;})
		.attr("y2", function (d) { return d[3]*lengthScale;})
		.attr("stroke", function(d, i) { return colorScale(i/(pendulumNumber + 5));});

	dots1 = pendulums
		.append('circle')
		.attr("class", "dots1")
		.attr("fill", function(d, i) { return colorScale(i/(pendulumNumber + 5));})
		.attr("cx", function (d) { return d[0]*lengthScale;})
		.attr("cy", function (d) { return d[1]*lengthScale;})
		.attr("r", constants[1]);
		
	dots2 = pendulums
		.append('circle')
		.attr("class", "dots2")
		.attr("fill", function(d, i) { return colorScale(i/(pendulumNumber + 5));})
		.attr("cx", function (d) { return d[2]*lengthScale;})
		.attr("cy", function (d) { return d[3]*lengthScale;})
		.attr("r", constants[3]);

	origin.append("circle")
		.attr("class", "origin-mark")
		.attr("r", 8)
		.style("fill", ()=>{return colorScale((pendulumNumber - 1)/(pendulumNumber + 5))});;

	currentCoords = initialCoords.clone();
}

function drawPendulumsAt(newCoords) {
	dots1.data(newCoords)
		.attr("cx", function (d) { return d[0]*lengthScale;})
		.attr("cy", function (d) { return d[1]*lengthScale;});
	dots2.data(newCoords)
		.attr("cx", function (d) { return d[2]*lengthScale;})
		.attr("cy", function (d) { return d[3]*lengthScale;});
		
	lines1.data(newCoords)
		.attr("x2", function (d) { return d[0]*lengthScale;})
		.attr("y2", function (d) { return d[1]*lengthScale;});
	
	lines2.data(newCoords)
		.attr("x1", function (d) { return d[0]*lengthScale;})
		.attr("y1", function (d) { return d[1]*lengthScale;})
		.attr("x2", function (d) { return d[2]*lengthScale;})
		.attr("y2", function (d) { return d[3]*lengthScale;});
}


function updateDisplay(){
	for (let i = 0; i < repeats; i++) {
		currentCoords = RK4LA(derivativeLA, stepSize, currentTime, currentCoords, constants);
	}
	currentTime += stepSize*repeats
	currentCartCoords = convertToCoordinates(currentCoords, constants)

	dots1.data(currentCartCoords)
		.attr("cx", function (d) { return d[0]*lengthScale;})
		.attr("cy", function (d) { return d[1]*lengthScale;});
	dots2.data(currentCartCoords)
		.attr("cx", function (d) { return d[2]*lengthScale;})
		.attr("cy", function (d) { return d[3]*lengthScale;});
		
	lines1.data(currentCartCoords)
		.attr("x2", function (d) { return d[0]*lengthScale;})
		.attr("y2", function (d) { return d[1]*lengthScale;});
	
	lines2.data(currentCartCoords)
		.attr("x1", function (d) { return d[0]*lengthScale;})
		.attr("y1", function (d) { return d[1]*lengthScale;})
		.attr("x2", function (d) { return d[2]*lengthScale;})
		.attr("y2", function (d) { return d[3]*lengthScale;});
	if (continueLooping) requestAnimationFrame(updateDisplay);
}

inputInitialData();

svg.on("click", () => {
	if (restartable) {
		restartable = false;
		drawPendulumsAt(initialCoordsCart);
		return;
	}
	if (!started){
		started = true;
		startLoop();
	}
	else {
		stopLoop();
		started = false;
	}});

svg.on("dblclick", () => {
	currentCoords = initialCoords.clone();});
</script>
</body>
</html>